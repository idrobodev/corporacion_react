"use strict";(self.webpackChunkfundacion_todo_por_un_alma=self.webpackChunkfundacion_todo_por_un_alma||[]).push([[441],{6938:(e,a,r)=>{r.d(a,{BZ:()=>l,DT:()=>t,F2:()=>m,Hc:()=>d,Ri:()=>o,Wk:()=>u,Zi:()=>n,ju:()=>c});var s=r(4349);const o=async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{if(!e||!e.trim())return{isValid:!1,error:"El n\xfamero de documento es requerido"};const r=await s.C5.getParticipantes();if(r.data&&Array.isArray(r.data)){if(r.data.some(r=>{const s=r.id||r.id_participante;return r.numero_documento===e&&s!==a}))return{isValid:!1,error:"El n\xfamero de documento ya est\xe1 registrado para otro participante"}}return{isValid:!0,error:null}}catch(r){return console.error("Error validating participante documento:",r),{isValid:!0,error:null}}},l=async function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;try{if(!e||!e.trim())return{isValid:!1,error:"El n\xfamero de documento es requerido"};const r=await s.C5.getAcudientes();if(r.data&&Array.isArray(r.data)){if(r.data.some(r=>{const s=r.id||r.id_acudiente;return r.numero_documento===e&&s!==a}))return{isValid:!1,error:"El n\xfamero de documento ya est\xe1 registrado para otro acudiente"}}return{isValid:!0,error:null}}catch(r){return console.error("Error validating acudiente documento:",r),{isValid:!0,error:null}}},t=e=>{if(!e||!e.trim())return{isValid:!1,error:"El email es requerido"};return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?{isValid:!0,error:null}:{isValid:!1,error:"El formato del email no es v\xe1lido"}},i=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"fecha";if(!e)return{isValid:!1,error:"La ".concat(a," es requerida")};const r=new Date(e),s=new Date;return s.setHours(23,59,59,999),r instanceof Date&&!isNaN(r.getTime())?r>s?{isValid:!1,error:"La ".concat(a," no puede ser futura")}:{isValid:!0,error:null}:{isValid:!1,error:"La ".concat(a," no es v\xe1lida")}},n=e=>i(e,"fecha de nacimiento"),d=e=>i(e,"fecha de ingreso"),c=async e=>{try{if(!e)return{isValid:!1,error:"Debe seleccionar un participante"};const a=await s.C5.getParticipantes();if(a.data&&Array.isArray(a.data)){if(!a.data.some(a=>(a.id_participante||a.id)===parseInt(e)))return{isValid:!1,error:"El participante seleccionado no existe"}}return{isValid:!0,error:null}}catch(a){return console.error("Error validating participante exists:",a),{isValid:!1,error:"Error al validar el participante"}}},u=async e=>{try{if(!e)return{isValid:!1,error:"Debe seleccionar una sede"};const a=await s.C5.getSedes();if(a.data&&Array.isArray(a.data)){if(!a.data.some(a=>(a.id_sede||a.id)===parseInt(e)))return{isValid:!1,error:"La sede seleccionada no existe"}}return{isValid:!0,error:null}}catch(a){return console.error("Error validating sede exists:",a),{isValid:!1,error:"Error al validar la sede"}}},m=async(e,a)=>{const r=await c(e);if(!r.isValid)return r;const o=await(async e=>{try{if(!e)return{isValid:!1,error:"Debe seleccionar un acudiente"};const a=await s.C5.getAcudientes();return a.data&&Array.isArray(a.data)&&!a.data.some(a=>(a.id_acudiente||a.id)===parseInt(e))?{isValid:!1,error:"El acudiente seleccionado no existe"}:{isValid:!0,error:null}}catch(a){return console.error("Error validating acudiente exists:",a),{isValid:!1,error:"Error al validar el acudiente"}}})(a);return o.isValid?{isValid:!0,error:null}:o}},9441:(e,a,r)=>{r.r(a),r.d(a,{default:()=>p});var s=r(5043),o=r(3474),l=r(4349),t=r(7522),i=r(3324),n=r(2144),d=r(1379),c=r(3714),u=r(6938),m=r(579);const g=()=>{const[e,a]=(0,s.useState)([]),[r,g]=(0,s.useState)(!0),[p,x]=(0,s.useState)(null),[f,h]=(0,s.useState)(!1),{filters:w,setFilter:b,clearFilters:y}=(0,c.R7)({rol:"Todos",busqueda:""}),N=(0,c.hS)(),A=(0,c.hS)(),D=(0,c.hS)(),j=(0,s.useCallback)(async()=>{try{var e;g(!0),x(null),console.log("\ud83d\udd04 Cargando usuarios...");const r=await l.C5.getUsuarios();if(console.log("\ud83d\udcca Resultado usuarios:",r),r.error)throw new Error(r.error.message||"Error al cargar usuarios");let s=[];s=Array.isArray(r.data)?r.data:Array.isArray(null===(e=r.data)||void 0===e?void 0:e.data)?r.data.data:[],a(s),console.log("\u2705 Usuarios cargados:",s.length)}catch(r){console.error("\u274c Error cargando usuarios:",r),x(r.message||"Error desconocido al cargar usuarios"),a([])}finally{g(!1)}},[]);(0,s.useEffect)(()=>(window.verModal=N,window.editarModal=A,window.deleteUser=async e=>{try{const a=await l.C5.deleteUsuario(e);a.error?alert("Error al eliminar usuario: "+a.error.message):(alert("Usuario eliminado exitosamente"),await j())}catch(p){alert("Error al eliminar usuario: "+p.message)}},()=>{delete window.verModal,delete window.editarModal,delete window.deleteUser}),[N,A,j]),(0,s.useEffect)(()=>{(async()=>{try{console.log("\ud83d\udd10 Verificando permisos de administrador...");const e=await l.C5.hasPermission(l.gg.ADMINISTRADOR);console.log("\u2705 Permisos de administrador obtenidos:",e),h(e),console.log("\ud83c\udfaf canEdit establecido como:",e)}catch(e){console.error("\u274c Error cargando permisos:",e),h(!1)}})(),j()},[j]);const v=(0,s.useMemo)(()=>{let a=Array.isArray(e)?e:[];return"Todos"!==w.rol&&(a=a.filter(e=>(e.rol||e.role)===w.rol)),w.busqueda&&(a=a.filter(e=>(e.email||"").toLowerCase().includes(w.busqueda.toLowerCase()))),a},[e,w]),E=(0,s.useMemo)(()=>[{title:"Total Usuarios",value:v.length,icon:"fas fa-users",color:"blue"}],[v]);if(r)return(0,m.jsx)(o.A,{title:"Usuarios",subtitle:"Gesti\xf3n de usuarios",loading:!0,loadingText:"Cargando usuarios..."});if(p)return(0,m.jsx)(o.A,{title:"Usuarios",subtitle:"Error al cargar datos",loading:!1,children:(0,m.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,m.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,m.jsxs)("p",{className:"text-red-600",children:["Error loading usuarios del sistema: ",p]})})})});if(!f)return(0,m.jsx)(o.A,{title:"Usuarios",subtitle:"Acceso denegado",children:(0,m.jsx)("div",{className:"flex items-center justify-center h-screen",children:(0,m.jsxs)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center max-w-md",children:[(0,m.jsx)("i",{className:"fas fa-lock text-yellow-600 text-5xl mb-4"}),(0,m.jsx)("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Acceso Denegado"}),(0,m.jsx)("p",{className:"text-gray-600",children:"No tienes permisos para acceder a esta p\xe1gina. Solo los administradores pueden gestionar usuarios."})]})})});const R=[{type:"select",name:"rol",label:"Rol",options:[{value:"Todos",label:"Todos los Roles"},{value:l.gg.ADMINISTRADOR,label:"Administrador"},{value:l.gg.CONSULTA,label:"Consulta"}]},{type:"search",name:"busqueda",label:"B\xfasqueda",placeholder:"Buscar por email..."}];return(0,m.jsxs)(o.A,{title:"Gesti\xf3n de Usuarios del sistema",subtitle:"Administra los usuarios del sistema",extraActions:f&&(0,m.jsxs)("button",{onClick:()=>D.openModal(),className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors",children:[(0,m.jsx)("i",{className:"fas fa-plus mr-2"}),"Nuevo Usuario"]}),children:[(0,m.jsxs)("section",{className:"px-4 md:px-6 py-4 md:py-6",children:[(0,m.jsx)(t.Qn,{filters:R,values:w,onChange:b,onClear:y,showClearButton:!0}),(0,m.jsx)("div",{className:"mt-6",children:(0,m.jsx)(i.MD,{stats:E,columns:3,gap:"md"})}),(0,m.jsx)("div",{className:"mt-6",children:(0,m.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200",children:[(0,m.jsx)("div",{className:"p-6 border-b border-gray-200",children:(0,m.jsxs)("div",{className:"flex items-center justify-between",children:[(0,m.jsxs)("div",{children:[(0,m.jsx)("h3",{className:"text-lg font-semibold text-gray-800",children:"Lista de Usuarios del sistema"}),(0,m.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Gestiona los usuarios del sistema"})]}),f?(0,m.jsxs)("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-green-100 text-green-800",children:[(0,m.jsx)("i",{className:"fas fa-user-shield mr-2"}),"Modo Administrador"]}):(0,m.jsxs)("span",{className:"inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800",children:[(0,m.jsx)("i",{className:"fas fa-eye mr-2"}),"Modo Solo Lectura"]})]})}),0===v.length?(0,m.jsxs)("div",{className:"p-12 text-center",children:[(0,m.jsx)("i",{className:"fas fa-users text-gray-300 text-4xl mb-4"}),(0,m.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No se encontraron usuarios del sistema"}),(0,m.jsx)("p",{className:"text-gray-500",children:"No hay usuarios que coincidan con los filtros aplicados."})]}):(0,m.jsx)(n.bQ,{columns:[{key:"email",header:"Email",render:e=>(0,m.jsxs)("div",{className:"flex items-center",children:[(0,m.jsx)("div",{className:"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center mr-3",children:(0,m.jsx)("i",{className:"fas fa-user text-blue-600"})}),(0,m.jsxs)("div",{children:[(0,m.jsx)("p",{className:"font-medium text-gray-900",children:e.email}),(0,m.jsxs)("p",{className:"text-sm text-gray-500",children:["ID: ",e.id_usuario||e.id]})]})]})},{key:"rol",header:"Rol",render:e=>{const a=e.rol||e.role;return(0,m.jsxs)("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ".concat(a===l.gg.ADMINISTRADOR||"ADMINISTRADOR"===a?"bg-purple-100 text-purple-800":"bg-green-100 text-green-800"),children:[(0,m.jsx)("i",{className:"fas ".concat(a===l.gg.ADMINISTRADOR||"ADMINISTRADOR"===a?"fa-user-shield":"fa-user"," mr-2")}),a===l.gg.ADMINISTRADOR||"ADMINISTRADOR"===a?"Administrador":"Consulta"]})}},{key:"acciones",header:"Acciones",render:e=>{if(console.log("\ud83d\udd0d Renderizando acciones para usuario:",e.email,"canEdit:",f),f){console.log("\ud83c\udfaf Renderizando ActionDropdown para:",e.email);const a=e.rol||e.role,r=a===l.gg.ADMINISTRADOR||"ADMINISTRADOR"===a;return(0,m.jsxs)("div",{className:"flex items-center space-x-2",children:[!r&&(0,m.jsx)("button",{onClick:()=>{console.log("\u270f\ufe0f Editar usuario:",e.email),A.openModal("edit",e)},className:"text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50 transition-colors",title:"Editar usuario",children:(0,m.jsx)("i",{className:"fas fa-edit"})}),!r&&(0,m.jsx)("button",{onClick:()=>{console.log("\ud83d\uddd1\ufe0f Eliminar usuario:",e.email),window.confirm("\xbfEst\xe1s seguro de que quieres eliminar este usuario?")&&window.deleteUser&&window.deleteUser(e.id_usuario||e.id)},className:"text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50 transition-colors",title:"Eliminar usuario",children:(0,m.jsx)("i",{className:"fas fa-trash"})}),r&&(0,m.jsxs)("span",{className:"text-xs text-gray-500 font-medium px-2 py-1 bg-gray-100 rounded",children:[(0,m.jsx)("i",{className:"fas fa-shield-alt mr-1"}),"Protegido"]})]})}return(0,m.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,m.jsxs)("button",{onClick:()=>{console.log("\ud83d\udc41\ufe0f Abriendo modal de solo lectura para:",e.email),N.openModal("view",e)},className:"text-blue-600 hover:text-blue-800 text-sm font-medium",children:[(0,m.jsx)("i",{className:"fas fa-eye mr-1"}),"Ver Detalles"]}),(0,m.jsxs)("span",{className:"text-xs text-yellow-600 font-medium",children:[(0,m.jsx)("i",{className:"fas fa-lock mr-1"}),"Solo Lectura"]})]})}}],data:v,keyExtractor:e=>e.id_usuario||e.id,loading:r})]})})]}),(0,m.jsx)(d.J$,{isOpen:N.isOpen,onClose:N.closeModal,title:"Detalles del Usuario del sistema",data:N.modalData?[{label:"ID",value:N.modalData.id_usuario||N.modalData.id},{label:"Email",value:N.modalData.email},{label:"Contrase\xf1a",value:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",helperText:"La contrase\xf1a est\xe1 oculta por seguridad"},{label:"Rol",value:(()=>{const e=N.modalData.rol||N.modalData.role;return e===l.gg.ADMINISTRADOR||"ADMINISTRADOR"===e?"Administrador":"Consulta"})()},{label:"Fecha de creaci\xf3n",value:new Date(N.modalData.created_at).toLocaleString("es-ES")},{label:"\xdaltima actualizaci\xf3n",value:new Date(N.modalData.updated_at).toLocaleString("es-ES")}]:[]}),(0,m.jsx)(d.M9,{isOpen:A.isOpen,onClose:A.closeModal,title:"Editar Usuario del sistema",onSubmit:async e=>{const a=(0,u.DT)(e.email);if(!a.isValid)throw new Error(a.error);if(!e.rol||e.rol!==l.gg.ADMINISTRADOR&&e.rol!==l.gg.CONSULTA&&"ADMINISTRADOR"!==e.rol&&"CONSULTA"!==e.rol)throw new Error("Rol inv\xe1lido");const r={email:e.email,role:e.rol};if(e.password&&e.password.trim()){if(e.password.length<8)throw new Error("La contrase\xf1a debe tener al menos 8 caracteres");r.password=e.password}const s=await l.C5.updateUsuario(A.modalData.id_usuario||A.modalData.id,r);if(s.error)throw new Error(s.error.message||"Error al actualizar usuario");await j()},initialData:A.modalData?{email:A.modalData.email,password:"",rol:A.modalData.rol||A.modalData.role}:{email:"",password:"",rol:l.gg.CONSULTA},fields:[{name:"email",label:"Email",type:"email",required:!0,placeholder:"usuario@ejemplo.com"},{name:"currentPassword",label:"Contrase\xf1a Actual (solo lectura)",type:"password",readOnly:!0,placeholder:"Contrase\xf1a actual del usuario",value:"\u2022\u2022\u2022\u2022\u2022\u2022\u2022\u2022",helperText:"La contrase\xf1a actual no se puede ver por seguridad"},{name:"password",label:"Nueva Contrase\xf1a (opcional)",type:"password",placeholder:"Dejar en blanco para mantener la actual",helperText:"M\xednimo 8 caracteres. Si se deja en blanco, mantiene la contrase\xf1a actual."},{name:"rol",label:"Rol",type:"select",required:!0,options:[{value:l.gg.CONSULTA,label:"Consulta"}]}]}),(0,m.jsx)(d.s5,{isOpen:D.isOpen,onClose:D.closeModal,title:"Nuevo Usuario del sistema",onSubmit:async e=>{const a=(0,u.DT)(e.email);if(!a.isValid)throw new Error(a.error);if(!e.password||e.password.length<8)throw new Error("La contrase\xf1a debe tener al menos 8 caracteres");if(!e.rol||e.rol!==l.gg.ADMINISTRADOR&&e.rol!==l.gg.CONSULTA&&"ADMINISTRADOR"!==e.rol&&"CONSULTA"!==e.rol)throw new Error("Rol inv\xe1lido");const r={email:e.email,password:e.password,role:e.rol},s=await l.C5.createUsuario(r);if(s.error)throw new Error(s.error.message||"Error al crear usuario");await j()},initialData:{email:"",password:"",rol:l.gg.CONSULTA},fields:[{name:"email",label:"Email",type:"email",required:!0,placeholder:"usuario@ejemplo.com"},{name:"password",label:"Contrase\xf1a",type:"password",required:!0,placeholder:"M\xednimo 8 caracteres",helperText:"M\xednimo 8 caracteres. La contrase\xf1a debe ser segura."},{name:"rol",label:"Rol",type:"select",required:!0,options:[{value:l.gg.ADMINISTRADOR,label:"Administrador"},{value:l.gg.CONSULTA,label:"Consulta"}]}]})]})},p=s.memo(g)}}]);
//# sourceMappingURL=441.fa470c85.chunk.js.map