import React, { useState, useEffect, useMemo, useCallback } from "react";
import DashboardLayout from "components/layout/DashboardLayout";
import { dbService } from "shared/services";
import { FilterBar, StatsGrid, DataTable, ActionDropdown, StatusToggle } from "components/ui";
import { ViewDetailsModal, EditFormModal, CreateFormModal } from "components/common";
import { useFilters, useModal } from "shared/hooks";
// import jsPDF from 'jspdf'; // Temporarily disabled - not available in Docker dev

const Participantes = React.memo(() => {
  const [participantes, setParticipantes] = useState([]); // Asegurar que siempre sea array
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  
  // Use the useFilters hook for filter state management
  const { filters: filtros, setFilter, clearFilters } = useFilters({
    sede: "Todas",
    genero: "Todos",
    estado: "Todos",
    busqueda: ""
  });

  // Use the useModal hook for modal state management
  const viewModal = useModal();
  const editModal = useModal();
  const createModal = useModal();

  // Funci√≥n para cargar participantes (usando useCallback para evitar re-renders)
  const loadParticipantes = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      console.log('üîÑ Cargando participantes...');
      
      const result = await dbService.getParticipantes();
      console.log('üìä Resultado participantes:', result);
      
      if (result.error) {
        throw new Error(result.error.message || 'Error al cargar participantes');
      }
      
      const participantesData = Array.isArray(result.data) ? result.data : [];
      setParticipantes(participantesData);
      console.log('‚úÖ Participantes cargados:', participantesData.length);
    } catch (err) {
      console.error('‚ùå Error cargando participantes:', err);
      setError(err.message || 'Error desconocido al cargar participantes');
      setParticipantes([]); // Asegurar que no quede undefined
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    loadParticipantes();
  }, [loadParticipantes]);

  // Funciones para manejar modales (memoized)
  const abrirModal = useCallback((tipo, participante) => {
    if (tipo === 'ver') {
      viewModal.openModal(null, participante);
    } else if (tipo === 'editar') {
      editModal.openModal(null, participante);
    } else if (tipo === 'crear') {
      createModal.openModal();
    }
  }, [viewModal, editModal, createModal]);

  const filteredParticipantes = useMemo(() => {
    // Asegurar que participantes siempre sea un array
    const safeParticipantes = Array.isArray(participantes) ? participantes : [];
    let filtered = safeParticipantes;

    if (filtros.sede !== "Todas") {
      filtered = filtered.filter(p => p.sede && p.sede.toLowerCase().includes(filtros.sede.toLowerCase()));
    }
    if (filtros.genero !== "Todos") {
      filtered = filtered.filter(p => p.genero === filtros.genero);
    }
    if (filtros.estado !== "Todos") {
      filtered = filtered.filter(p => p.estado === filtros.estado);
    }
    if (filtros.busqueda) {
      filtered = filtered.filter(p =>
        (p.nombre || '').toLowerCase().includes(filtros.busqueda.toLowerCase()) ||
        (p.telefono || '').includes(filtros.busqueda)
      );
    }
    return filtered;
  }, [participantes, filtros]);

  const toggleEstado = useCallback(async (id, newEstado) => {
    try {
      await dbService.updateParticipante(id, { estado: newEstado });
      // Refresh data
      const { data } = await dbService.getParticipantes();
      setParticipantes(data || []);
    } catch (err) {
      console.error('Error updating status:', err);
    }
  }, []);

  const handleActionClick = useCallback((action, participante) => {
    switch (action) {
      case 'ver':
        abrirModal('ver', participante);
        break;
      case 'editar':
        abrirModal('editar', participante);
        break;
      default:
        // No action
        break;
    }
  }, [abrirModal]);

  const handleExportPDF = useCallback(() => {
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const currentDate = new Date().toLocaleDateString('es-ES');

    // Generate HTML content for PDF
    const htmlContent = `
      <!DOCTYPE html>
      <html>
        <head>
          <title>Lista de Participantes - ${currentDate}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              margin: 20px;
              color: #333;
            }
            .header {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px solid #333;
              padding-bottom: 20px;
            }
            .header h1 {
              color: #2563eb;
              margin: 0;
              font-size: 24px;
            }
            .filters {
              margin-bottom: 20px;
              background: #f8f9fa;
              padding: 15px;
              border-radius: 5px;
            }
            .filters h3 {
              margin: 0 0 10px 0;
              color: #495057;
            }
            .filters p {
              margin: 5px 0;
              font-size: 14px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
            }
            th, td {
              border: 1px solid #ddd;
              padding: 8px 12px;
              text-align: left;
            }
            th {
              background-color: #f8f9fa;
              font-weight: bold;
              color: #495057;
            }
            tr:nth-child(even) {
              background-color: #f9f9f9;
            }
            .stats {
              margin-top: 30px;
              background: #e3f2fd;
              padding: 15px;
              border-radius: 5px;
            }
            .stats h3 {
              margin: 0 0 10px 0;
              color: #1976d2;
            }
            .stats p {
              margin: 5px 0;
              font-size: 14px;
            }
            @media print {
              body { margin: 0; }
              .no-print { display: none; }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>Lista de Participantes</h1>
            <p>Corporaci√≥n Todo por un Alma</p>
            <p>Fecha de generaci√≥n: ${currentDate}</p>
          </div>

          <div class="filters">
            <h3>Filtros aplicados:</h3>
            <p><strong>Sede:</strong> ${filtros.sede === 'Todas' ? 'Todas las sedes' : filtros.sede}</p>
            <p><strong>G√©nero:</strong> ${filtros.genero === 'Todos' ? 'Todos los g√©neros' : filtros.genero}</p>
            <p><strong>Estado:</strong> ${filtros.estado === 'Todos' ? 'Todos los estados' : filtros.estado}</p>
            ${filtros.busqueda ? `<p><strong>B√∫squeda:</strong> "${filtros.busqueda}"</p>` : ''}
          </div>

          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Edad</th>
                <th>G√©nero</th>
                <th>Tel√©fono</th>
                <th>Sede</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              ${filteredParticipantes.map(participante => `
                <tr>
                  <td>${participante.nombre || 'N/A'}</td>
                  <td>${participante.edad || 'N/A'}</td>
                  <td>${participante.genero || 'N/A'}</td>
                  <td>${participante.telefono || 'N/A'}</td>
                  <td>${participante.sede || 'N/A'}</td>
                  <td>${participante.estado || 'N/A'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="stats">
            <h3>Estad√≠sticas:</h3>
            <p><strong>Total de participantes:</strong> ${filteredParticipantes.length}</p>
            <p><strong>Activos:</strong> ${filteredParticipantes.filter(p => p.estado === 'Activo').length}</p>
            <p><strong>Inactivos:</strong> ${filteredParticipantes.filter(p => p.estado === 'Inactivo').length}</p>
          </div>

          <script>
            window.onload = function() {
              window.print();
              setTimeout(function() {
                window.close();
              }, 1000);
            }
          </script>
        </body>
      </html>
    `;

    printWindow.document.write(htmlContent);
    printWindow.document.close();
  }, [filtros, filteredParticipantes]);

  if (loading) {
    return (
      <DashboardLayout title="Participantes" subtitle="Gesti√≥n de participantes" loading={true} loadingText="Cargando participantes..." />
    );
  }

  if (error) {
    return (
      <DashboardLayout title="Participantes" subtitle="Error al cargar datos" loading={false}>
        <div className="flex items-center justify-center h-screen">
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="text-red-600">Error loading participants: {error}</p>
          </div>
        </div>
      </DashboardLayout>
    );
  }

  return (
    <DashboardLayout title="Gesti√≥n de Participantes" subtitle="Administra los participantes de la fundaci√≥n" extraActions={
      <div className="flex space-x-3">
        <button
          onClick={() => handleExportPDF()}
          className="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors"
          title="Exportar lista filtrada a PDF"
        >
          <i className="fas fa-file-pdf mr-2"></i>
          Exportar PDF
        </button>
        <button
          onClick={() => abrirModal('crear', null)}
          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
        >
          <i className="fas fa-plus mr-2"></i>
          Nuevo Participante
        </button>
      </div>
    }>
      {/* Filtros */}
      <FilterBar
        filters={[
          {
            type: 'select',
            name: 'sede',
            label: 'Sede',
            options: [
              { value: 'Todas', label: 'Todas las Sedes' },
              { value: 'Bello Principal', label: 'Bello Principal' },
              { value: 'Bello Campestre', label: 'Bello Campestre' },
              { value: 'Apartad√≥', label: 'Apartad√≥' }
            ]
          },
          {
            type: 'select',
            name: 'genero',
            label: 'G√©nero',
            options: [
              { value: 'Todos', label: 'Todos los G√©neros' },
              { value: 'MASCULINO', label: 'Masculino' },
              { value: 'FEMENINO', label: 'Femenino' }
            ]
          },
          {
            type: 'select',
            name: 'estado',
            label: 'Estado',
            options: [
              { value: 'Todos', label: 'Todos los Estados' },
              { value: 'Activo', label: 'Activo' },
              { value: 'Inactivo', label: 'Inactivo' }
            ]
          },
          {
            type: 'search',
            name: 'busqueda',
            placeholder: 'Nombre, tel√©fono...',
            debounceMs: 300
          }
        ]}
        values={filtros}
        onChange={setFilter}
        onClear={clearFilters}
        showClearButton={true}
      />


      {/* Estad√≠sticas R√°pidas */}
      <div className="px-6 py-4">
        <StatsGrid
          stats={[
            {
              title: 'Total Participantes',
              value: filteredParticipantes.length,
              icon: 'fas fa-users',
              color: 'blue'
            },
            {
              title: 'Activos',
              value: filteredParticipantes.filter(p => p.estado === "Activo").length,
              icon: 'fas fa-user-check',
              color: 'green'
            },
            {
              title: 'Inactivos',
              value: filteredParticipantes.filter(p => p.estado === "Inactivo").length,
              icon: 'fas fa-user-times',
              color: 'red'
            },
            {
              title: 'Promedio Edad',
              value: filteredParticipantes.length > 0
                ? `${Math.round(filteredParticipantes.reduce((sum, p) => sum + (p.edad || 0), 0) / filteredParticipantes.length)} a√±os`
                : '0 a√±os',
              icon: 'fas fa-birthday-cake',
              color: 'blue'
            },
            {
              title: 'Sedes Bello',
              value: filteredParticipantes.filter(p => p.sede && p.sede.toLowerCase().includes("bello")).length,
              icon: 'fas fa-map-marker-alt',
              color: 'purple'
            }
          ]}
          columns={5}
          gap="md"
        />
      </div>

      {/* Tabla de Participantes */}
      <div className="px-6 py-4">
        <div className="bg-white rounded-lg shadow-sm border border-gray-200">
          <div className="p-6 border-b border-gray-200">
            <h3 className="text-lg font-semibold text-gray-800">Lista de Participantes</h3>
          </div>
          
          <DataTable
            data={filteredParticipantes}
            keyExtractor={(row) => row.id}
            columns={[
              {
                key: 'participante',
                header: 'Participante',
                render: (row) => (
                  <div className="flex items-center">
                    <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                      <i className="fas fa-user text-blue-600"></i>
                    </div>
                    <div className="ml-4">
                      <div className="text-sm font-medium text-gray-900">
                        {row.nombre}
                      </div>
                      <div className="text-sm text-gray-500">
                        {row.edad} a√±os ‚Ä¢ {row.telefono}
                      </div>
                    </div>
                  </div>
                )
              },
              {
                key: 'genero',
                header: 'G√©nero',
                render: (row) => (
                  row.genero === 'MASCULINO' ? 'Masculino' : row.genero === 'FEMENINO' ? 'Femenino' : 'N/A'
                )
              },
              {
                key: 'sede',
                header: 'Sede',
                render: (row) => row.sede
              },
              {
                key: 'estado',
                header: 'Estado',
                render: (row) => (
                  <StatusToggle
                    currentStatus={row.estado}
                    statuses={[
                      { value: 'Activo', label: 'Activo', variant: 'success' },
                      { value: 'Inactivo', label: 'Inactivo', variant: 'danger' }
                    ]}
                    onChange={(newEstado) => toggleEstado(row.id, newEstado)}
                  />
                )
              },
              {
                key: 'acciones',
                header: 'Acciones',
                render: (row) => (
                  <ActionDropdown
                    actions={[
                      {
                        label: 'Ver detalles',
                        icon: 'fas fa-eye',
                        onClick: () => handleActionClick('ver', row)
                      },
                      {
                        label: 'Editar',
                        icon: 'fas fa-edit',
                        onClick: () => handleActionClick('editar', row)
                      }
                    ]}
                  />
                )
              }
            ]}
            loading={loading}
          />
        </div>
      </div>

      {/* Modales */}
      <ViewDetailsModal
        isOpen={viewModal.isOpen}
        onClose={viewModal.closeModal}
        title="Detalles del Participante"
        data={viewModal.modalData ? [
          { label: 'Nombre Completo', value: viewModal.modalData.nombre },
          { label: 'Edad', value: `${viewModal.modalData.edad} a√±os` },
          { label: 'Tel√©fono', value: viewModal.modalData.telefono },
          { label: 'Sede', value: viewModal.modalData.sede },
          { 
            label: 'Estado', 
            value: (
              <span className={`inline-flex px-3 py-1 text-sm font-semibold rounded-full ${
                viewModal.modalData.estado === 'Activo' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
              }`}>
                {viewModal.modalData.estado}
              </span>
            )
          },
          { 
            label: 'Fecha de Ingreso', 
            value: viewModal.modalData.fechaIngreso
              ? new Date(viewModal.modalData.fechaIngreso).toLocaleDateString('es-ES')
              : 'No disponible'
          }
        ] : []}
      />

      <ParticipanteEditModal
        isOpen={editModal.isOpen}
        onClose={editModal.closeModal}
        participante={editModal.modalData}
        onActualizar={loadParticipantes}
      />

      <ParticipanteCreateModal
        isOpen={createModal.isOpen}
        onClose={createModal.closeModal}
        onCrear={loadParticipantes}
      />
    </DashboardLayout>
  );
});

// Helper function for sede options by gender
  return (
    <>
      <div className="flex items-center justify-between p-6 border-b border-gray-200">
        <h3 className="text-xl font-semibold text-gray-800">Detalles del Participante</h3>
        <button 
          onClick={onCerrar}
          className="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors"
        >
          <i className="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div className="p-6">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Nombre Completo</label>
              <p className="text-lg font-semibold text-gray-800">{participante.nombre}</p>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Edad</label>
              <p className="text-gray-800">{participante.edad} a√±os</p>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Tel√©fono</label>
              <p className="text-gray-800">{participante.telefono}</p>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Sede</label>
              <p className="text-gray-800">{participante.sede}</p>
            </div>
          </div>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Estado</label>
              <span className={`inline-flex px-3 py-1 text-sm font-semibold rounded-full ${
                participante.estado === 'Activo' ? 'bg-green-100 text-green-800' :
                'bg-red-100 text-red-800'
              }`}>
                {participante.estado}
              </span>
            </div>
            
            <div>
              <label className="block text-sm font-medium text-gray-600 mb-1">Fecha de Ingreso</label>
              <p className="text-gray-800">
                {participante.fechaIngreso
                  ? new Date(participante.fechaIngreso).toLocaleDateString('es-ES')
                  : 'No disponible'
                }
              </p>
            </div>
            
            
          </div>
        </div>
      </div>
      
      <div className="flex justify-end p-6 border-t border-gray-200 space-x-3">
        <button 
          onClick={onCerrar}
          className="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
        >
          Cerrar
        </button>
      </div>
    </>
  );
});

// Componente Modal para Editar Participante (memoized)
const ModalEditarParticipante = React.memo(({ participante, onCerrar, onActualizar }) => {
  const [formData, setFormData] = useState({
    nombre: participante.nombre,
    edad: participante.edad,
    telefono: participante.telefono,
    genero: participante.genero || 'MASCULINO', // Default if not provided
    sede: participante.sede,
    estado: participante.estado,
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Opciones de sedes por g√©nero
  const getSedesPorGenero = (genero) => {
    if (genero === 'MASCULINO') {
      return [
        { value: 'Sede Masculina Bello Principal', label: 'Bello Principal Masculina' },
        { value: 'Sede Masculina Bello Campestre', label: 'Bello Campestre Masculina' },
        { value: 'Sede Masculina Apartad√≥', label: 'Apartad√≥ Masculina' },
      ];
    } else {
      return [
        { value: 'Sede Femenina Bello Principal', label: 'Bello Principal Femenina' },
        { value: 'Sede Femenina Apartad√≥', label: 'Apartad√≥ Femenina' },
      ];
    }
  };

  // Actualizar sede cuando cambia el g√©nero
  const handleGeneroChange = (genero) => {
    const sedesDisponibles = getSedesPorGenero(genero);
    const nuevaSede = sedesDisponibles[0]?.value || '';
    setFormData(prev => ({
      ...prev,
      genero,
      sede: nuevaSede
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');

    try {
      console.log('üîÑ Actualizando participante:', formData);

      const result = await dbService.updateParticipante(participante.id, formData);

      if (result.error) {
        throw new Error(result.error.message || 'Error al actualizar participante');
      }

      console.log('‚úÖ Participante actualizado exitosamente');
      onActualizar(); // Recargar la lista
      onCerrar();
    } catch (err) {
      console.error('‚ùå Error actualizando participante:', err);
      setError(err.message || 'Error desconocido al actualizar participante');
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      <div className="flex items-center justify-between p-6 border-b border-gray-200">
        <h3 className="text-xl font-semibold text-gray-800">Editar Participante</h3>
        <button 
          onClick={onCerrar}
          className="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors"
        >
          <i className="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <form onSubmit={handleSubmit} className="p-6">
        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p className="text-red-600 text-sm">{error}</p>
          </div>
        )}

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Nombre Completo</label>
            <input
              type="text"
              value={formData.nombre}
              onChange={(e) => setFormData({...formData, nombre: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Edad</label>
            <input
              type="number"
              value={formData.edad}
              onChange={(e) => setFormData({...formData, edad: parseInt(e.target.value)})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">G√©nero</label>
            <select
              value={formData.genero}
              onChange={(e) => handleGeneroChange(e.target.value)}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
              <option value="MASCULINO">Masculino</option>
              <option value="FEMENINO">Femenino</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Tel√©fono</label>
            <input
              type="tel"
              value={formData.telefono}
              onChange={(e) => setFormData({...formData, telefono: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Sede</label>
            <select
              value={formData.sede}
              onChange={(e) => setFormData({...formData, sede: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
              {getSedesPorGenero(formData.genero).map(sede => (
                <option key={sede.value} value={sede.value}>
                  {sede.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Estado</label>
            <select
              value={formData.estado}
              onChange={(e) => setFormData({...formData, estado: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
              <option value="Activo">Activo</option>
              <option value="Inactivo">Inactivo</option>
            </select>
          </div>

        </div>
        
        <div className="flex justify-end mt-6 space-x-3">
          <button
            type="button"
            onClick={onCerrar}
            disabled={loading}
            className="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50"
          >
            Cancelar
          </button>
          <button
            type="submit"
            disabled={loading}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? (
              <>
                <i className="fas fa-spinner fa-spin mr-2"></i>
                Guardando...
              </>
            ) : (
              <>
                <i className="fas fa-save mr-2"></i>
                Guardar Cambios
              </>
            )}
          </button>
        </div>
      </form>
    </>
  );
});

// Componente Modal para Crear Participante (memoized)
const ModalCrearParticipante = React.memo(({ onCerrar, onCrear }) => {
  const [formData, setFormData] = useState({
    nombre: '',
    edad: '',
    telefono: '',
    genero: 'MASCULINO',
    sede: 'Sede Masculina Bello Principal',
    estado: 'Activo',
  });
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');

  // Opciones de sedes por g√©nero
  const getSedesPorGenero = (genero) => {
    if (genero === 'MASCULINO') {
      return [
        { value: 'Sede Masculina Bello Principal', label: 'Bello Principal Masculina' },
        { value: 'Sede Masculina Bello Campestre', label: 'Bello Campestre Masculina' },
        { value: 'Sede Masculina Apartad√≥', label: 'Apartad√≥ Masculina' },
      ];
    } else {
      return [
        { value: 'Sede Femenina Bello Principal', label: 'Bello Principal Femenina' },
        { value: 'Sede Femenina Apartad√≥', label: 'Apartad√≥ Femenina' },
      ];
    }
  };

  // Actualizar sede cuando cambia el g√©nero
  const handleGeneroChange = (genero) => {
    const sedesDisponibles = getSedesPorGenero(genero);
    const nuevaSede = sedesDisponibles[0]?.value || '';
    setFormData(prev => ({
      ...prev,
      genero,
      sede: nuevaSede
    }));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    
    try {
      console.log('üîÑ Creando participante:', formData);
      
      // Validaciones b√°sicas
      if (!formData.nombre.trim()) {
        throw new Error('El nombre es requerido');
      }
      if (!formData.telefono.trim()) {
        throw new Error('El tel√©fono es requerido');
      }
      
      const result = await dbService.createParticipante(formData);
      
      if (result.error) {
        throw new Error(result.error.message || 'Error al crear participante');
      }
      
      console.log('‚úÖ Participante creado exitosamente');
      onCrear(); // Recargar la lista
      onCerrar(); // Cerrar modal
    } catch (err) {
      console.error('‚ùå Error creando participante:', err);
      setError(err.message || 'Error desconocido al crear participante');
    } finally {
      setLoading(false);
    }
  };

  return (
    <>
      <div className="flex items-center justify-between p-6 border-b border-gray-200">
        <h3 className="text-xl font-semibold text-gray-800">Nuevo Participante</h3>
        <button 
          onClick={onCerrar}
          className="text-gray-400 hover:text-gray-600 p-2 rounded-lg hover:bg-gray-100 transition-colors"
        >
          <i className="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <form onSubmit={handleSubmit} className="p-6">
        {error && (
          <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <p className="text-red-600 text-sm">{error}</p>
          </div>
        )}
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
            <input
              type="text"
              value={formData.nombre}
              onChange={(e) => setFormData({...formData, nombre: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Ingrese el nombre completo"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Edad</label>
            <input
              type="number"
              value={formData.edad}
              onChange={(e) => setFormData({...formData, edad: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Edad"
              min="1"
              max="120"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">G√©nero *</label>
            <select
              value={formData.genero}
              onChange={(e) => handleGeneroChange(e.target.value)}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              required
            >
              <option value="MASCULINO">Masculino</option>
              <option value="FEMENINO">Femenino</option>
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label>
            <input
              type="tel"
              value={formData.telefono}
              onChange={(e) => setFormData({...formData, telefono: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="N√∫mero de tel√©fono"
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Sede</label>
            <select
              value={formData.sede}
              onChange={(e) => setFormData({...formData, sede: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              {getSedesPorGenero(formData.genero).map(sede => (
                <option key={sede.value} value={sede.value}>
                  {sede.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Estado</label>
            <select
              value={formData.estado}
              onChange={(e) => setFormData({...formData, estado: e.target.value})}
              className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="Activo">Activo</option>
              <option value="Inactivo">Inactivo</option>
            </select>
          </div>
        </div>
        
        <div className="flex justify-end mt-6 space-x-3">
          <button 
            type="button"
            onClick={onCerrar}
            disabled={loading}
            className="px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50"
          >
            Cancelar
          </button>
          <button 
            type="submit"
            disabled={loading}
            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {loading ? (
              <>
                <i className="fas fa-spinner fa-spin mr-2"></i>
                Creando...
              </>
            ) : (
              <>
                <i className="fas fa-plus mr-2"></i>
                Crear Participante
              </>
            )}
          </button>
        </div>
      </form>
    </>
  );
});

// Helper function for sede options by gender
const getSedesPorGenero = (genero) => {
  if (genero === 'MASCULINO') {
    return [
      { value: 'Sede Masculina Bello Principal', label: 'Bello Principal Masculina' },
      { value: 'Sede Masculina Bello Campestre', label: 'Bello Campestre Masculina' },
      { value: 'Sede Masculina Apartad√≥', label: 'Apartad√≥ Masculina' },
    ];
  } else {
    return [
      { value: 'Sede Femenina Bello Principal', label: 'Bello Principal Femenina' },
      { value: 'Sede Femenina Apartad√≥', label: 'Apartad√≥ Femenina' },
    ];
  }
};

// Edit Modal Component
const ParticipanteEditModal = ({ isOpen, onClose, participante, onActualizar }) => {
  if (!participante) return null;

  const handleSubmit = async (formData) => {
    console.log('üîÑ Actualizando participante:', formData);
    const result = await dbService.updateParticipante(participante.id, formData);
    
    if (result.error) {
      throw new Error(result.error.message || 'Error al actualizar participante');
    }
    
    console.log('‚úÖ Participante actualizado exitosamente');
    onActualizar();
  };

  return (
    <EditFormModal
      isOpen={isOpen}
      onClose={onClose}
      title="Editar Participante"
      initialData={{
        nombre: participante.nombre,
        edad: participante.edad,
        telefono: participante.telefono,
        genero: participante.genero || 'MASCULINO',
        sede: participante.sede,
        estado: participante.estado,
      }}
      onSubmit={handleSubmit}
      submitLabel="Guardar Cambios"
    >
      {({ formData, handleChange, errors }) => (
        <ParticipanteForm 
          formData={formData} 
          handleChange={handleChange} 
          errors={errors}
        />
      )}
    </EditFormModal>
  );
};

// Create Modal Component
const ParticipanteCreateModal = ({ isOpen, onClose, onCrear }) => {
  const handleSubmit = async (formData) => {
    console.log('üîÑ Creando participante:', formData);
    
    if (!formData.nombre.trim()) {
      throw new Error('El nombre es requerido');
    }
    if (!formData.telefono.trim()) {
      throw new Error('El tel√©fono es requerido');
    }
    
    const result = await dbService.createParticipante(formData);
    
    if (result.error) {
      throw new Error(result.error.message || 'Error al crear participante');
    }
    
    console.log('‚úÖ Participante creado exitosamente');
    onCrear();
  };

  return (
    <CreateFormModal
      isOpen={isOpen}
      onClose={onClose}
      title="Nuevo Participante"
      defaultValues={{
        nombre: '',
        edad: '',
        telefono: '',
        genero: 'MASCULINO',
        sede: 'Sede Masculina Bello Principal',
        estado: 'Activo',
      }}
      onSubmit={handleSubmit}
      submitLabel="Crear Participante"
    >
      {({ formData, handleChange, errors }) => (
        <ParticipanteForm 
          formData={formData} 
          handleChange={handleChange} 
          errors={errors}
        />
      )}
    </CreateFormModal>
  );
};

// Shared Form Component (will be refactored in task 12.5)
const ParticipanteForm = ({ formData, handleChange, errors }) => {
  const [localGenero, setLocalGenero] = React.useState(formData.genero);

  const handleGeneroChange = (genero) => {
    setLocalGenero(genero);
    const sedesDisponibles = getSedesPorGenero(genero);
    const nuevaSede = sedesDisponibles[0]?.value || '';
    handleChange('genero', genero);
    handleChange('sede', nuevaSede);
  };

  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label>
        <input
          type="text"
          value={formData.nombre}
          onChange={(e) => handleChange('nombre', e.target.value)}
          className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Ingrese el nombre completo"
          required
        />
        {errors?.nombre && <p className="text-red-600 text-sm mt-1">{errors.nombre}</p>}
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Edad</label>
        <input
          type="number"
          value={formData.edad}
          onChange={(e) => handleChange('edad', e.target.value)}
          className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="Edad"
          min="1"
          max="120"
        />
        {errors?.edad && <p className="text-red-600 text-sm mt-1">{errors.edad}</p>}
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">G√©nero *</label>
        <select
          value={formData.genero}
          onChange={(e) => handleGeneroChange(e.target.value)}
          className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          required
        >
          <option value="MASCULINO">Masculino</option>
          <option value="FEMENINO">Femenino</option>
        </select>
        {errors?.genero && <p className="text-red-600 text-sm mt-1">{errors.genero}</p>}
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Tel√©fono *</label>
        <input
          type="tel"
          value={formData.telefono}
          onChange={(e) => handleChange('telefono', e.target.value)}
          className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          placeholder="N√∫mero de tel√©fono"
          required
        />
        {errors?.telefono && <p className="text-red-600 text-sm mt-1">{errors.telefono}</p>}
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Sede</label>
        <select
          value={formData.sede}
          onChange={(e) => handleChange('sede', e.target.value)}
          className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          {getSedesPorGenero(formData.genero).map(sede => (
            <option key={sede.value} value={sede.value}>
              {sede.label}
            </option>
          ))}
        </select>
        {errors?.sede && <p className="text-red-600 text-sm mt-1">{errors.sede}</p>}
      </div>

      <div>
        <label className="block text-sm font-medium text-gray-700 mb-2">Estado</label>
        <select
          value={formData.estado}
          onChange={(e) => handleChange('estado', e.target.value)}
          className="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        >
          <option value="Activo">Activo</option>
          <option value="Inactivo">Inactivo</option>
        </select>
        {errors?.estado && <p className="text-red-600 text-sm mt-1">{errors.estado}</p>}
      </div>
    </div>
  );
};

export default Participantes;
